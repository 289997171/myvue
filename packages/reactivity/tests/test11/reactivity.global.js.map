{
  "version": 3,
  "sources": ["../src/index.ts", "../../shared/src/index.ts", "../src/effect.ts", "../src/reactive.ts"],
  "sourcesContent": ["export {reactive} from './reactive'\r\nexport {effect} from './effect'\r\n", "export const isObject = (val)=> {\r\n    return val !== null && typeof val === 'object'\r\n}\r\n", "// \u5F53\u524D\u6B63\u5728\u8FDB\u884C\u6536\u96C6\u7684effect\r\n// \u5BFC\u51FA\u7684\u662F\u53D8\u91CF,\u76F8\u5F53\u4E0E\u6307\u9488,\u5E76\u4E0D\u662Fundefined\u503C!!!\r\nexport let collectingEffect = undefined;\r\n\r\nclass ReactiveEffect {\r\n    // \u662F\u5426\u9700\u8981\u6536\u96C6\u5BF9\u5E94\u51FD\u6570\u4E2D\u7684\u54CD\u5E94\u5F0F\u53D8\u91CF,\u9ED8\u8BA4true:\u9700\u8981\u8FDB\u884C\u6536\u96C6\r\n    needCollect = true;\r\n    // \u7531\u4E8E\u53EF\u80FD\u5D4C\u5957effect\u7684\u60C5\u51B5,\u6211\u4EEC\u9700\u8981\u8BB0\u5F55\u5F53\u524Deffect\u7684\u7236effect,\u4ECE\u800C\u89E3\u51B3\u5D4C\u5957\u5E26\u6765activeEffect\u4E0D\u660E\u786E\u7684\u95EE\u9898!\r\n    // \u76F8\u5BF9\u4E8E\u5165\u6808\u51FA\u6808\u6027\u80FD\u66F4\u597D\r\n    parentEF = undefined;\r\n    // [ef1,ef2, ...]\r\n    deps = []\r\n\r\n    constructor(public renderFn) {\r\n    }\r\n\r\n    run() {\r\n        // \u5982\u679C\u4E0D\u9700\u8981\u6536\u96C6,\u76F4\u63A5\u6267\u884C\u5BF9\u5E94\u7684\u6E32\u67D3\u51FD\u6570\r\n        if (!this.needCollect) this.renderFn()\r\n        else {\r\n            // \u8FDB\u884C\u4F9D\u8D56\u6536\u96C6,\u6838\u5FC3\u5C31\u662F\u5C06\u5F53\u524D\u7684effect \u548C \u7A0D\u540E\u6E32\u67D3\u7684\u5C5E\u6027\u8FDB\u884C\u5173\u8054\r\n\r\n            try {\r\n                // \u8003\u8651effect\u5D4C\u5957\u60C5\u51B5\u4E0B,\u5F53\u524Deffect\u6539\u53D8\u5168\u5C40activeEffect\u4E4B\u524D,\u8BB0\u5F55\u7236effect\r\n                this.parentEF = collectingEffect;\r\n\r\n                // \u5F53\u524Deffect\u7B2C\u4E00\u6B21run\u7684\u65F6\u5019,\u5C06\u5176\u4FDD\u5B58\u5230\u5168\u5C40\u53D8\u91CF\u4E2D\r\n                collectingEffect = this;\r\n\r\n                // TODO \u89E3\u51B3\u5206\u652F\u6E32\u67D3,\u6536\u96C6\u5C5E\u6027\u4F9D\u65E7\u4FDD\u5B58\u4E0D\u5FC5\u8981\u7684\u5C5E\u6027\u95EE\u9898\r\n                // TODO \u5982\u591A\u5F53\u524D\u6267\u884C\u662F\u56E0\u4E3Atrigger,\u90A3\u4E48\u4F1A\u5BFC\u81F4\u6B7B\u5FAA\u73AF\r\n                /*\r\n                 \u6B7B\u5FAA\u73AF\u539F\u56E0:\r\n                 let set = new Set(['a])\r\n                 set.forEach(item=> {\r\n                    set.delete('a')\r\n                    set.add('a')\r\n                 })\r\n                */\r\n                {\r\n                    // this.deps = [] \u4E0D\u80FD\u8FD9\u6837\u5904\u7406,\u8FD9\u6837\u4EC5\u4EC5\u662F\u5C06\u81EA\u5DF1\u7684\u6570\u7EC4\u4FEE\u6539,\u6211\u4EEC\u9700\u8981\u5C06deps\u91CC\u9762\u7684set\u6E05\u7A7A\u540E,\u91CD\u65B0\u6536\u96C6\r\n                    for (let i = 0; i < this.deps.length; i++) {\r\n                        this.deps[i].delete(this) // \u8FD9\u91CC\u5220\u9664\u540E,targetP_EFs \u5BF9\u5E94\u7684\u4E5F\u4F1A\u88AB\u5220\u9664\r\n                    }\r\n                    this.deps.length = 0;\r\n                }\r\n\r\n                // \u6267\u884C\u5BF9\u5E94\u7684\u6E32\u67D3\u51FD\u6570,\u8BE5\u6E32\u67D3\u51FD\u6570\u6267\u884C\u65F6\u5C31\u80FD\u83B7\u5F97\u5168\u5C40\u7684activeEffect\r\n                // \u90A3\u4E48\u6E32\u67D3\u51FD\u6570\u4E2D\u7684\u54CD\u5E94\u5F0F\u53D8\u91CFProxy\u5728\u6267\u884Cget\u7684\u65F6\u5019\u4E5F\u80FD\u83B7\u5F97\u5168\u5C40\u7684activeEffect,\u4ECE\u800C\u5C06\u54CD\u5E94\u5F0F\u53D8\u91CF\u4E0Eeffect\u8FDB\u884C\u5173\u8054\r\n                return this.renderFn();\r\n            } finally {\r\n                collectingEffect = this.parentEF;\r\n                this.parentEF = null;\r\n\r\n\r\n                // TODO \u7531\u4E8E\u89E3\u51B3\u5D4C\u5957\u6267\u884C\u4F9D\u8D56 collectingEffect,\u800CcollectingEffect\u4F9D\u8D56\u5C5E\u6027\u6536\u96C6,\u6545\u8FD9\u91CC\u4E0D\u80FD\u53D6\u6D88\u5C5E\u6027\u6536\u96C6!\r\n                // TODO \u7531\u4E8E\u6761\u4EF6\u6E32\u67D3,\u5982\u679Ceffect\u53EA\u5728\u7B2C\u4E00\u6B21\u6267\u884C\u7684\u65F6\u5019\u6536\u96C6\u4F9D\u8D56,\u4E5F\u4E0D\u80FD\u8FBE\u5230\u6548\u679C,\u6545\u8FD9\u91CC\u4E0D\u80FD\u53D6\u6D88\u5C5E\u6027\u6536\u96C6!\r\n                // this.needCollect = false;\r\n            }\r\n\r\n        }\r\n\r\n    }\r\n}\r\n\r\n/**\r\n * effect\u9ED8\u8BA4\u6267\u884C\u4E00\u6B21\r\n * effect\u6838\u5FC3\u903B\u8F91\u662F\u6536\u96C6\u51FD\u6570\u4E2D\u7684\u54CD\u5E94\u5F0F\u53D8\u91CF,\r\n * \u6BCF\u5F53\u6536\u96C6\u7684\u54CD\u5E94\u5F0F\u53D8\u91CF\u6539\u53D8,\u89E6\u53D1effect\u5BF9\u5E94\u7684\u51FD\u6570\u91CD\u65B0\u6267\u884C\r\n * @param renderFn \u6E32\u67D3\u51FD\u6570\r\n */\r\nconst effect = (renderFn) => {\r\n\r\n    const re = new ReactiveEffect(renderFn)\r\n\r\n    // \u9ED8\u8BA4\u6267\u884C\u4E00\u6B21\r\n    re.run()\r\n}\r\n\r\n/**\r\n * \u6536\u96C6\u5BF9\u8C61\u7684\u90A3\u4E9B\u5C5E\u6027\u5BFC\u81F4\u90A3\u4E9Beffect\u6267\u884C!!!\r\n * \u5BF9\u8C61 -> \u5C5E\u6027 -> effect\r\n * k: \u539F\u59CB\u5BF9\u8C61\r\n * v: Map\r\n *      k: \u539F\u59CB\u5BF9\u8C61\u7684\u5C5E\u6027\u540D\u79F0\r\n *      v: Set \u4FDD\u5B58effect,\u5C31\u662F\u8BE5\u5C5E\u6027\u53EF\u80FD\u5BFC\u81F4\u90A3\u4E9Beffect\u6E32\u67D3\u51FD\u6570\u91CD\u65B0\u6E32\u67D3\r\n *      {obj, {p: [ef1, ef2, ...]}}\r\n */\r\nconst targetP_EFs = new WeakMap();\r\n/**\r\n * Proxy\u6267\u884C\u7684\u6536\u96C6\u51FD\u6570\r\n * @param target \u539F\u59CB\u5BF9\u8C61\r\n * @param type get/set \u4E00\u822C\u662FProxy:get\r\n * @param p \u539F\u59CB\u5BF9\u8C61\u7684\u5C5E\u6027\r\n */\r\nconst track = (target, type, p) => {\r\n    if (!collectingEffect) {\r\n        //console.warn('\u5F53\u524D\u6CA1\u6709\u6B63\u5728\u8FDB\u884C\u4F9D\u8D56\u6536\u96C6\u7684effect, \u8FD9\u79CD\u60C5\u51B5\u5B58\u5728\u4E8E\u6E32\u67D3\u51FD\u6570\u5728\u975Eeffect\u4E2D\u6267\u884C')\r\n        return;\r\n    }\r\n\r\n    let depsMap = targetP_EFs.get(target)\r\n    if (!depsMap) {\r\n        // k:\u5C5E\u6027\u540D v:Set\r\n        targetP_EFs.set(target, depsMap = new Map())\r\n    }\r\n\r\n    let dep = depsMap.get(p)\r\n    if (!dep) {\r\n        depsMap.set(p, dep = new Set())\r\n    }\r\n\r\n    if (!dep.has(collectingEffect)) {\r\n        console.log('track...', p)\r\n        // \u53CC\u5411\u5173\u8054,\u591A\u5BF9\u591A\r\n        dep.add(collectingEffect) // \u6CE8\u610FcollectingEffect\u4E4B\u540E\u6539\u53D8\u4E0D\u4F1A\u5F71\u54CDdep\u91CC\u9762\u7684\u503C!!!\r\n        collectingEffect.deps.push(dep) // \u8BA9effect\u8BB0\u5F55\u5BF9\u5E94\u7684dep,\u5728\u4E4B\u540E\u6E05\u7406\u7684\u65F6\u5019\u4F1A\u7528\u5230\r\n    }\r\n\r\n    // \u6253\u5370\u5BF9\u8C61\u88AB\u6536\u96C6\u5230\u7684\u5C5E\u6027\r\n    console.log('depsMap', depsMap)\r\n}\r\n\r\n\r\n/*\r\n\u9700\u8981\u8003\u8651\u5D4C\u5957\u60C5\u51B5,\u4F9D\u8D56parentEF\r\n\r\neffect(()=> {\r\n    xxx.xxx\r\n    effect(()=> {\r\n        yyy.yyy\r\n    })\r\n\r\n    effect(()=> {\r\n        yyy.yyy\r\n    })\r\n})\r\n\r\n\r\n\u9700\u8981\u8003\u8651effect\u5220\u9664\u4F9D\u8D56\u7684\u60C5\u51B5\r\n\u5F53flag\u6539\u53D8,\u5BF9\u5E94proxy\u6536\u96C6\u7684\u5C5E\u6027\u4E5F\u6539\u53D8\u4E86\r\neffect(()=> {\r\n    flag ? proxy.xxx : proxy.yyy\r\n})\r\n*/\r\n\r\n\r\nconst trigger = (target, type, p, newValue, oldValue) => {\r\n    const pEFs = targetP_EFs.get(target)\r\n    if (!pEFs) return; // \u89E6\u53D1\u7684\u503C,\u6CA1\u6709\u5BF9\u5E94\u7684effects\r\n\r\n    const efs = pEFs.get(p)\r\n    if (efs) {\r\n        console.log('trigger...', p)\r\n        // \u62F7\u8D1Defs\u8FDB\u884C\u904D\u5386,\r\n        // \u65B0\u7684_efs\u53EF\u80FD\u89E6\u53D1\u5220\u9664\r\n        // \u8001\u7684 efs\u53EF\u80FD\u8FDB\u884C\u6DFB\u52A0\r\n        const _efs = new Set<ReactiveEffect>(efs)\r\n        _efs.forEach(effect => {\r\n\r\n            // \u8003\u8651\u5D4C\u5957\u5FAA\u73AF,\u6267\u884Ceffect.run\u53EF\u80FD\u662Feffect\u672C\u8EAB\r\n            /*\r\n                \u53C2\u89C1: test71.html\r\n                effect(()=> {\r\n                    console.log('effect...')\r\n\r\n                    // TODO effect\u4E2D\u4FEE\u6539\u6536\u5230\u7684\u7684\u5C5E\u6027\u503C,\u5C06\u5BFC\u81F4\u5D4C\u5957\u5FAA\u73AF!!!\r\n                    // set \u5BFC\u81F4 effect\r\n                    // effect \u5BFC\u81F4 set\r\n                    // ...\u5D4C\u5957\u5FAA\u73AF\r\n                    state.age++\r\n\r\n                    document.getElementById('app').innerHTML = `${state.name} \u4ECA\u5E74 ${state.age} \u5C81`\r\n                })\r\n            */\r\n            if (effect === collectingEffect) console.warn('effect\u4E2D\u4FEE\u6539\u6536\u5230\u7684\u7684\u5C5E\u6027\u503C,\u5FFD\u7565\u89E6\u53D1,\u76F4\u63A5\u5728\u5F53\u524D\u6E32\u67D3\u51FD\u6570\u5C31\u80FD\u751F\u6548!')\r\n            else effect.run()\r\n        })\r\n    }\r\n}\r\n\r\n\r\nexport {effect, track, trigger}\r\n", "import {isObject} from \"@vue/shared\";\r\n\r\n// \u83B7\u5F97\u5F53\u524D\u6B63\u5728\u8FDB\u884C\u4F9D\u8D56\u6536\u96C6\u7684effect\r\nimport {track, trigger} from './effect'\r\n\r\nconst enum ReactiveFlag {\r\n    IS_REACTIVE = '__v_isReactive'\r\n}\r\n\r\n// \u4FDD\u5B58\u4EE5\u53CA\u539F\u59CB\u5BF9\u8C61\u4E0E\u4EE3\u7406\u5BF9\u8C61\u9690\u5C04\r\nconst reactiveMap = new WeakMap() // key\u53EA\u80FD\u662F\u5BF9\u8C61,\u5982\u679Ckey\u6307\u5411\u7684\u5BF9\u8C61\u540E\u9762\u8D4B\u503C\u4E3Anull,\u90A3\u4E48WeakMap\u4F1A\u81EA\u52A8\u5220\u9664,\u5783\u573E\u56DE\u6536\u76F8\u5173\r\n\r\n/**\r\n * \u5C06js\u539F\u59CB\u5BF9\u8C61,\u4F9D\u8D56Proxy\u8F6C\u6362\u6210\u54CD\u5E94\u5F0F\u6570\u636E\r\n * 1.reactive\u53EA\u652F\u6301\u5BF9\u8C61\u7684\u8F6C\u6362\r\n * @param target\r\n */\r\nconst reactive = (target)=> {\r\n    // 1.reactive\u53EA\u652F\u6301\u5BF9\u8C61\u7684\u8F6C\u6362\r\n    if (!isObject(target)) {\r\n        console.error('reactive\u53EA\u652F\u6301\u5BF9\u8C61\u7684\u8F6C\u6362:', target)\r\n        return\r\n    }\r\n\r\n    // \u5982\u679Ctarget\u662F\u4E00\u4E2A\u4EE3\u7406\u5BF9\u8C61Proxy,\u76F4\u63A5\u8FD4\u56DE\r\n    if (target[ReactiveFlag.IS_REACTIVE]) return target;\r\n\r\n    // \u5224\u65AD\u539F\u59CB\u5BF9\u8C61\u662F\u5426\u5DF2\u7ECF\u521B\u5EFA\u8FC7\u5BF9\u5E94\u7684\u4EE3\u7406\u5BF9\u8C61\r\n    let proxy = reactiveMap.get(target)\r\n    if (proxy)  return proxy;\r\n\r\n    proxy = new Proxy(target, {\r\n        get(target: any, p: string | symbol, receiver: any): any {\r\n            //return target[p]\r\n            // \u4E3A\u4EE3\u7406\u5BF9\u8C61\u6DFB\u52A0\u6807\u5FD7\r\n            if (p === ReactiveFlag.IS_REACTIVE) return true\r\n\r\n            // \u8FDB\u884C\u4F9D\u8D56\u6536\u96C6\r\n            track(target, 'get', p)\r\n\r\n            return Reflect.get(target, p, receiver);\r\n        },\r\n        set(target: any, p: string | symbol, value: any, receiver: any): boolean {\r\n            // target[p] = value;\r\n            // return true;\r\n\r\n            let result = false;\r\n\r\n            const oldValue = target[p]\r\n            if (oldValue !== value) { // \u6570\u636E\u53D8\u5316\u624D\u66F4\u65B0\r\n                result = Reflect.set(target, p, value, receiver)\r\n\r\n                // \u89E6\u53D1\u5C5E\u6027\u5BFC\u81F4effect\u6E32\u67D3\r\n                trigger(target, 'set', p, value, oldValue)\r\n            }\r\n\r\n            return result;\r\n        }\r\n    })\r\n\r\n    // \u5C06\u539F\u59CB\u5BF9\u8C61\u4E0E\u4EE3\u7406\u5BF9\u8C61\u5EFA\u7ACB\u9690\u5C04\r\n    reactiveMap.set(target, proxy)\r\n    return proxy\r\n}\r\n\r\nexport {reactive}\r\n"],
  "mappings": "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",
  "names": ["effect", "target"]
}
